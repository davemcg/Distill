---
title: "Modeling"
output: html_notebook
---

# Load data from ~/git/EGA_EGAD00001002656_NGS_reanalyze/scripts/stats.Rmd
UK10K data
```{r}
#load('/Volumes/Arges_NFS/PROJECTS/mcgaughey/EGA_EGAD00001002656_NGS_reanalyze/clean_data/gemini_out_variants_het_and_hom.Rdata')
#load('~/git/EGA_EGAD00001002656_NGS_reanalyze/uk10k_gemini_rare_variants.Rdata')
load('/Volumes/data/uk10k_gemini_rare_variants.Rdata')
```

## Set up data for modeling
```{r}
library(tidyverse)

all_processed <- uk10k_gemini_rare_variants %>% 
  separate(gene_eyediseaseclass, c('RDGene','DiseaseClass'), sep='_') %>%  #split off RD disease type
  select(-RDGene) %>% 
  mutate(impact_severity = case_when(impact_severity == 'HIGH' ~ 3, # convert to integer 
                                      impact_severity == 'MED' ~ 2, 
                                      TRUE ~ 1),
         Status = case_when(Status=='Pathogenic' ~ 'Pathogenic',
                            TRUE ~ 'NotPathogenic'),
          genesplicer = case_when(genesplicer == "" ~ 'No',
                                 grepl('^gain', genesplicer) ~ 'Gain',
                                 grepl('^loss', genesplicer) ~ 'Loss',
                                 grepl('^diff', genesplicer) ~ 'Diff',
                                 TRUE ~ 'Else')) %>% 
  mutate(Status = factor(Status, levels=c('Pathogenic','NotPathogenic'))) %>% 
  mutate_at(vars(matches('ac_|an_|^n_')), funs(as.integer(.))) %>% # convert columns with ac_|whatever to integer (ac is allele count)
  mutate_at(vars(matches('af_|dann|revel|mpc|gerp|polyphen_score|sift_score|fitcons_float|gerp_elements|^adj|_z$|^pli$|^pnull$|precessive|^phylop')), funs(as.numeric(.))) %>%  # af is allele frequency
select(variant_id, Status, Complicated_Status, is_exonic, is_coding, is_lof, is_splicing, impact_severity, polyphen_score, sift_score, dann, gerp_elements, DiseaseClass, mpc, revel, aaf_1kg_afr_float:an_exac_sas, fitcons_float, gno_ac_afr:gno_an_popmax, lof_z:precessive, phylop_100way, grantham, maxentscan, cadd_phred, fathmm_mkl_coding_score, genesplicer, spliceregion) %>% 
  filter(max_aaf_all < 0.01) %>% 
   unique() # remove any common variants %>% 


all_processed[is.na(all_processed)] <- -1

all_PATH <- all_processed %>% 
  filter(Status=='Pathogenic') %>% 
  unique()
all_NOT_PATH <- all_processed %>% 
  filter(Status=='NotPathogenic') %>% 
  unique()

all_set__uk10k <- all_processed
all_set__uk10k$Source <- 'UK10K'

all_PATH <- all_set__uk10k %>% filter(Status=='Pathogenic')
# cut down pathogenic 
set.seed(115470)
all_NOT_PATH__CUT <- all_set__uk10k %>% filter(Status=='NotPathogenic') #%>% sample_n(20000)

ML_set__UK10K <- rbind(all_PATH, all_NOT_PATH__CUT)
```


# Load clinvar rd pathogenic data
```{r}
library(here)
library(data.table)
clinvar <- fread(paste0('gzcat ', here('processed_data/clinvar.gemini.tsv.gz')))
```


## Prep data for modeling
```{r}
clinvar_processed <- clinvar %>% 
  separate(gene_eyediseaseclass, c('RDGene','DiseaseClass'), sep='_') %>%  #split off RD disease type
  select(-RDGene) %>% 
  mutate(impact_severity = case_when(impact_severity == 'HIGH' ~ 3, # convert to integer 
                                      impact_severity == 'MED' ~ 2, 
                                      TRUE ~ 1),
         Status = case_when(status=='PATHOGENIC_RD' ~ 'Pathogenic',
                            TRUE ~ 'NotPathogenic'),
         genesplicer = case_when(genesplicer == "" ~ 'No',
                                 grepl('^gain', genesplicer) ~ 'Gain',
                                 grepl('^loss', genesplicer) ~ 'Loss',
                                 grepl('^diff', genesplicer) ~ 'Diff',
                                 TRUE ~ 'Else')) %>% 
  mutate(Status = factor(Status, levels=c('Pathogenic','NotPathogenic'))) %>% 
  mutate_at(vars(matches('ac_|an_|^n_')), funs(as.integer(.))) %>% # convert columns with ac_|whatever to integer (ac is allele count)
  mutate_at(vars(matches('af_|dann|revel|mpc|gerp|polyphen_score|sift_score|fitcons_float|gerp_elements|^adj|_z$|^pli$|^pnull$|precessive|^phylop_100')), funs(as.numeric(.))) %>%  # af is allele frequency
select(variant_id, Status, is_exonic, is_coding, is_lof, is_splicing, impact_severity, polyphen_score, sift_score, dann, gerp_elements, DiseaseClass, mpc, revel, aaf_1kg_afr_float:an_exac_sas, fitcons_float, gno_ac_afr:gno_an_popmax, lof_z:precessive, phylop_100way, grantham, maxentscan, cadd_phred, fathmm_mkl_coding_score, genesplicer, spliceregion) %>% 
    filter(max_aaf_all < 0.01) # remove any common variants

clinvar_processed[is.na(clinvar_processed)] <- -1

all_PATH <- clinvar_processed %>% 
  filter(Status == 'Pathogenic') %>% 
  unique()
all_NOT_PATH <- clinvar_processed %>% 
  filter(Status != 'Pathogenic') %>% 
  unique()

all_set__clinvar <- clinvar_processed
all_set__clinvar$Source <- 'ClinVar'

all_PATH <- all_set__clinvar %>% filter(Status=='Pathogenic')
# cut down pathogenic to 5x of path
set.seed(115470)
all_NOT_PATH__CUT <- all_set__clinvar %>% filter(Status=='NotPathogenic')

ML_set__clinvar <- rbind(all_PATH, all_NOT_PATH__CUT)

```


# Combine UK10K and ClinVar data
```{r}
all_processed <- bind_rows(all_set__clinvar %>% select_(.dots = colnames(all_set__uk10k %>% select(-Complicated_Status))), all_set__uk10k %>% select(-Complicated_Status)) 
ML_set__all <- bind_rows(ML_set__clinvar %>% select_(.dots = colnames(ML_set__UK10K %>% select(-Complicated_Status))), ML_set__UK10K %>% select(-Complicated_Status))

# temporary <- only keep a columns present in both
```

# Quick Stats
```{r}
dim(all_processed)
all_processed %>% group_by(Status, Source) %>% summarise(Count=n())

ML_set__all %>% group_by(Status, Source) %>% summarise(Count=n())
```

## One hot encoding (Dummy variables)
Turn categorical factors into variables

Many ML algorithms can't handle factor

You can feed this into the `Train and Test sets` section below if you are using something like a GLM or NN. 

```{r}
library(dummies)
temp <- ML_set__all %>% dplyr::select(-Status, -Source, -variant_id)
temp <- dummy.data.frame(temp, sep='_')
ML_set_dummy <- temp %>% mutate(variant_id = ML_set__all$variant_id, Status = ML_set__all$Status, Source = ML_set__all$Source)
# recreate for full data
temp <- all_processed %>% dplyr::select(-Status, -Source)
temp <- dummy.data.frame(temp, sep='_')
all_dummy <- temp %>% mutate(Status = all_processed$Status, Source = all_processed$Source)
```

## Train and Validate and Test sets
Split in training / validating / testing

```{r}
set.seed(115470)
train_set <- all_processed %>% 
  group_by(Status, Source) %>% 
 # filter(!Complicated_Status=='Comp_Het') %>% # remove comp hets for now
  sample_frac(0.33) %>% ungroup()
# remove no variance columns
#var_columns <- colnames(train_set)[apply(train_set, MARGIN = 2, function(x) var(x) > 0)]
#var_columns <- var_columns[!is.na(var_columns)]
#train_set <- train_set[,c(var_columns, 'Status', 'Complicated_Status')]

set.seed(115470)
validate_set <- all_processed %>% 
  filter(!variant_id %in% train_set$variant_id) %>% 
  group_by(Status, Source) %>% 
  sample_frac(0.5) %>% ungroup()

test_set <- all_processed %>% 
  filter(!variant_id %in% c(train_set$variant_id, validate_set$variant_id))
# remove no variance columns
#var_columns <- colnames(test_set)[apply(test_set, MARGIN = 2, function(x) var(x) > 0)]
#var_columns <- var_columns[!is.na(var_columns)]
#test_set <- test_set[,c(var_columns, 'Status', 'Complicated_Status')]
```


# Model!
```{r}
library(caret)
library(mlbench)
library(parallel)
library(doParallel)
library(MLmetrics)
#library(plotROC)

# CV on rf seems to overfit
fitControl_RF <- trainControl(
  classProbs=T,
  savePredictions = T,
  allowParallel = T,
  summaryFunction = prSummary,
  returnData = T)

# for the nonRF models
fitControl <- trainControl(## 5-fold CV
  method = "cv",
  number = 5,
  classProbs=T,
  savePredictions = T,
  allowParallel = T,
  summaryFunction = prSummary,
  returnData = T)
  
cluster <- makeCluster(detectCores() - 1) # leave some cores for me!
registerDoParallel(cluster)

rfFit <- caret::train(Status ~ ., data=train_set %>% select(-variant_id, -Source),
                      preProcess = c("scale", "center"),
                      method = "rf", metric='AUC',
                      trControl = fitControl_RF)

bglmFit <- caret::train(Status ~ ., data=train_set %>% select(-variant_id, -Source), 
                      preProcess = c("scale", "center"),
                      method = "bayesglm", metric='F',
                      trControl = fitControl)

# check again, had errors when running
glmboostFit <- caret::train(Status ~ ., data=train_set %>% select(-variant_id, -Source),
                      preProcess = c("scale", "center"),
                      method = "glmboost", metric='F',
                      trControl = fitControl)

LogitBoostFit <- caret::train(Status ~ ., data=train_set %>% select(-variant_id, -Source), 
                      preProcess = c("scale", "center"),
                      method = "LogitBoost", metric='F',
                      trControl = fitControl)

avNNetFit <- caret::train(Status ~ ., data=train_set %>% select(-variant_id, -Source), 
                      preProcess = c("scale", "center"),
                      method = "avNNet", metric='F',
                      trControl = fitControl)

# tossed, terrible performance
# xgbTreeFit <- caret::train(Status ~ ., data=train_set %>% select(-variant_id, -Source), 
#                       preProcess = c("scale", "center"),
#                       method = "xgbTree",  metric='AUC',
#                       trControl = fitControl)

stepLDAFit <- caret::train(Status ~ ., data=train_set %>% select(-variant_id, -Source), 
                      preProcess = c("scale", "center"),
                      method = "stepLDA",  metric='AUC',
                      trControl = fitControl)

# tossed, terrible performance
# naive_bayesFit <- caret::train(Status ~ ., data=train_set %>% select(-variant_id, -Source), 
#                       preProcess = c("scale", "center"),
#                       method = "naive_bayes",  metric='AUC',
#                       trControl = fitControl)

dnnFit <- caret::train(Status ~ ., data=train_set %>% select(-variant_id, -Source), 
                      preProcess = c("scale", "center"),
                      method = "dnn",  metric='AUC',
                      trControl = fitControl)

# mlpKerasDropoutFit <- caret::train(x = train_set %>% select(-variant_id, -Source, -Status),
#                                  y= train_set$Status,
#                       preProcess = c("scale", "center"),
#                       method = "mlpKerasDropout",  metric='F',
#                       trControl = fitControl)

monmlpFit <- caret::train(Status ~ ., data=train_set %>% select_(.dots=c('Status',most_imp_predictors)), 
                         preProcess = c("scale", "center"),
                         method = "monmlp",  metric='F',
                         trControl = fitControl_min)


svmLinearWeightsFit <- caret::train(Status ~ ., data=train_set %>% select(-variant_id, -Source), 
                      preProcess = c("scale", "center"),
                      method = "svmLinearWeights",  metric='Precision',
                      trControl = fitControl)

caddFit <- caret::train(Status ~ ., data=train_set %>% select(cadd_phred, Status), 
                      preProcess = c("scale", "center"),
                      method = "glm",  metric='Precision',
                      trControl = fitControl)

cadd_plus_DiseaseClassFit <- caret::train(Status ~ ., data=train_set %>% select(cadd_phred, Status, `DiseaseClass_-1`), 
                      preProcess = c("scale", "center"),
                      method = "glm",  metric='Precision',
                      trControl = fitControl)

revelFit <- caret::train(Status ~ ., data=train_set %>% select(revel, Status), 
                      preProcess = c("scale", "center"),
                      method = "glm",
                      trControl = fitControl)

revelFit_plus_DiseaseClassFit <- caret::train(Status ~ ., data=train_set %>% select(revel, Status, `DiseaseClass_-1`), 
                      preProcess = c("scale", "center"),
                      method = "glm",
                      trControl = fitControl)

dannFit <- caret::train(Status ~ ., data=train_set %>% select(dann, Status), 
                      preProcess = c("scale", "center"),
                      method = "glm",
                      trControl = fitControl)

dann_plus_DiseaseClassFit <- caret::train(Status ~ ., data=train_set %>% select(dann, Status, `DiseaseClass_-1`), 
                      preProcess = c("scale", "center"),
                      method = "glm",
                      trControl = fitControl)

my_models <- list(rfFit,bglmFit,glmboostFit,LogitBoostFit,avNNetFit, xgbTreeFit,stepLDAFit, dnnFit, svmLinearWeightsFit, caddFit, cadd_plus_DiseaseClassFit)
names(my_models) <- c('rfFit','bglmFit','glmboostFit','LogitBoostFit', 'avNNetFit', 'stepLDAFit', 'dnnFit', 'svmLinearWeightsFit', 'caddFit', 'caddDiseaseClassFit')
```

# ConfusionMatrix your model(s)
```{r}
# fuller_data is many variants, minus the variants in the test_set and train set
# doesn't use all of the benign variants, as want to save some for the final test
set.seed(42359)
all_dummy_1 <- all_dummy %>% sample_frac(0.5)
all_dummy_2 <- all_dummy %>% filter(!variant_id %in% all_dummy_1$variant_id)

fuller_data = all_dummy_1 %>% filter(!variant_id %in% c(test_set$variant_id, train_set$variant_id))

# center scale
fuller_data_CS = preProcess(fuller_data, method = c('center','scale')) %>% predict(., fuller_data)

cm_maker <- function(model, data, cutoff=0.5) {
  new_predictions <- predict(model, data, type='prob') %>%
    mutate(Answers = data$Status, Prediction = case_when(Pathogenic > cutoff ~ 'Pathogenic', TRUE ~ 'NotPathogenic'))
  confusionMatrix(data = new_predictions$Prediction, reference = new_predictions$Answers, mode='prec_recall')
}
#example
cm_maker(bglmFit, fuller_data_CS, cutoff=0.5)
#cm_maker(avNNetFit, fuller_data_CS, cutoff=0.5)
cm_maker(rfFit, fuller_data_CS, cutoff=0.5)
```


# AUC ROC
```{r, fig.width=5, fig.height=1.5}
library(PRROC)
library(cowplot)

# precision recall AUC
aucroc_maker <- function(model, data, cutoff=0.5) {
  new_predictions <- predict(model, data, type = 'prob') %>%
    mutate(Answers = data$Status, Prediction = case_when(Pathogenic > cutoff ~ 'Pathogenic', TRUE ~ 'NotPathogenic'))
  pr.curve(scores.class0 = new_predictions %>% filter(Answers=='Pathogenic') %>% pull(Pathogenic),
           scores.class1 = new_predictions %>% filter(Answers=='NotPathogenic') %>% pull(Pathogenic),
           curve = T)
}

# ROC AUC
roc_maker <- function(model, data, cutoff=0.5) {
  new_predictions <- predict(model, data, type = 'prob') %>%
    mutate(Answers = data$Status, Prediction = case_when(Pathogenic > cutoff ~ 'Pathogenic', TRUE ~ 'NotPathogenic'))
  roc.curve(scores.class0 = new_predictions %>% filter(Answers=='Pathogenic') %>% pull(Pathogenic),
           scores.class1 = new_predictions %>% filter(Answers=='NotPathogenic') %>% pull(Pathogenic),
           curve = T)
}

aucroc_data <- data.frame()
for (i in names(my_models)){
  print(my_models[[i]]$method)
  aucroc <- aucroc_maker(my_models[[i]], fuller_data)
  out <- aucroc$curve[,1:2] %>% data.frame()
  colnames(out) <- c('Recall','Precision')
  out$AUC <- aucroc$auc.integral
  out$model <- i
  out$'Model (AUC)' <- paste0(i, ' (',round(aucroc$auc.integral,2),')' )
  aucroc_data <- rbind(aucroc_data, out)
}

roc_data <- data.frame()
for (i in names(my_models)){
  print(my_models[[i]]$method)
  roc <- roc_maker(my_models[[i]], fuller_data)
  out <- roc$curve[,1:2] %>% data.frame()
  colnames(out) <- c('FPR','Sensitivity')
  out$model <- i
  out$AUC <- roc$auc
  out$'Model (AUC)' <- paste0(i, ' (',round(roc$auc, 2),')' )
  roc_data <- rbind(roc_data, out)
}

pr <- aucroc_data %>% ggplot(aes(x=Recall, y=Precision, colour=`Model (AUC)`)) + geom_line() + theme_minimal() + ggtitle('Precision Recall Curve')
roc <- roc_data %>% ggplot(aes(x=FPR, y=Sensitivity, colour=`Model (AUC)`)) + geom_line() + theme_minimal()  + ggtitle('ROC')

cowplot::plot_grid(roc, pr)
```
